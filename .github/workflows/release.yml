name: Automated Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.2.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Build and Release Gem
    runs-on: ubuntu-latest
    if: github.repository_owner == 'RubyRaider'

    environment:
      name: rubygems.org
      url: https://rubygems.org/gems/ruby_raider

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Use input from manual trigger
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract from tag (strips the 'v' prefix)
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Verify version matches lib/version
        run: |
          LIB_VERSION=$(cat lib/version | tr -d '[:space:]')
          TAG_VERSION="${{ steps.version.outputs.version }}"
          if [ "$LIB_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: lib/version ($LIB_VERSION) does not match requested version ($TAG_VERSION)"
            exit 1
          fi
          echo "✓ Version verified: $LIB_VERSION"

      - name: Run tests
        run: |
          bundle exec rspec spec/generators/
          bundle exec rspec spec/integration/ --tag ~slow

      - name: Run RuboCop
        run: bundle exec rubocop

      - name: Run Reek
        run: bundle exec reek

      - name: Build gem
        run: |
          gem build ruby_raider.gemspec
          echo "Built: $(ls -1 *.gem)"

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag for comparison
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release - no previous tag"
            CHANGELOG="Initial release"
          else
            echo "Generating changelog since $PREV_TAG"
            CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Extract stats
          FEATURES=$(echo "$CHANGELOG" | grep -iE "feat|add|new" | wc -l || echo 0)
          FIXES=$(echo "$CHANGELOG" | grep -iE "fix|bug" | wc -l || echo 0)
          CHANGES=$(echo "$CHANGELOG" | grep -c "^-" || echo 0)

          cat > RELEASE_NOTES.md << EOF
          ## What's Changed
          $CHANGELOG

          ## Statistics
          - Total commits: $CHANGES
          - Features/Additions: $FEATURES
          - Bug fixes: $FIXES

          ## Installation
          \`\`\`bash
          gem install ruby_raider -v ${{ steps.version.outputs.version }}
          \`\`\`
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          # Use the version for the tag name if triggered manually
          tag_name: v${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            *.gem
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to RubyGems
        uses: rubygems/release-gem@v1
        with:
          gem-push: true
        env:
          RUBYGEMS_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}

      - name: Notify success
        if: success()
        run: |
          echo "✓ Release ${{ steps.version.outputs.version }} published successfully!"
